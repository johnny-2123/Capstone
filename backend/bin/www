#!/usr/bin/env node
require('dotenv').config();

const { port } = require('../config');
const app = require('../app');
const db = require('../db/models');
const http = require('http');
const WebSocket = require('ws');
const { v4: uuidv4 } = require('uuid');

const guid = uuidv4();

db.sequelize
    .authenticate()
    .then(() => {
        console.log('Database connection success! Sequelize is ready to use...');

        const server = http.createServer(app);

        const wss = new WebSocket.Server({ server });

        const clients = new Map();

        wss.on('connection', (ws) => {
            console.log('Client connected');

            ws.isAlive = true;
            ws.on('pong', () => {
                ws.isAlive = true;
            });

            ws.on('message', (message) => {
                console.log('received: %s', message);

                const { type, data } = JSON.parse(message);
                console.log('type:', type);
                // console.log('data:', data)
                if (type === 'join') {
                    // Join the room
                    const { room, username } = data;
                    ws.room = room;
                    ws.username = username;

                    // Store the client in the room
                    if (!clients.has(room)) {
                        clients.set(room, new Set());
                    }
                    clients.get(room).add(ws);
                } else if (type === 'message') {
                    // Broadcast the message to the room
                    const room = ws.room;
                    const username = ws.username;
                    if (clients.has(room)) {
                        const roomClients = clients.get(room);
                        roomClients.forEach((client) => {
                            const message = JSON.stringify(`${username}: ${data.message}`);
                            client.send(message, (error) => {
                                if (error) {
                                    console.log(`WebSocket send error: ${error}`);
                                }
                            });
                        });
                    }
                }
            });

            ws.on('error', (error) => {
                console.log(`WebSocket error: ${error}`);
            });

            ws.on('close', () => {
                console.log('Client disconnected');

                // Remove the client from the room
                const room = ws.room;
                if (clients.has(room)) {
                    clients.get(room).delete(ws);
                    if (clients.get(room).size === 0) {
                        clients.delete(room);
                    }
                }

                const username = ws.username;
            });
        });

        setInterval(() => {
            wss.clients.forEach((ws) => {
                if (!ws.isAlive) return ws.terminate();

                ws.isAlive = false;
                ws.ping();
            });
        }, 30000);

        server.listen(port, () => console.log(`Listening on port ${port}...`));
    })
    .catch((err) => {
        console.log('Database connection failure.');
        console.error(err);
    });
